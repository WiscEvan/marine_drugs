# Autometa Makeflow DAG
LENGTH_FILTER=/home/evan/miniconda3/envs/autometa/bin/autometa-length-filter
COVERAGES=/home/evan/miniconda3/envs/autometa/bin/autometa-coverage
KMERS=/home/evan/miniconda3/envs/autometa/bin/autometa-kmers
ORFS=/home/evan/tools/programs_3rd_party/prokka/binaries/linux/prodigal
MARKERS=/home/evan/miniconda3/envs/autometa/bin/autometa-markers
TAXONOMY=/home/evan/miniconda3/envs/autometa/bin/autometa-taxonomy
BINNING=/home/evan/miniconda3/envs/autometa/bin/autometa-binning
RECRUITMENT=/home/evan/miniconda3/envs/autometa/bin/autometa-unclustered-recruitment
BLASTP=/home/evan/tools/programs_3rd_party/diamond


CATEGORY="recruitment"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.recruitment.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.dbscan.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
    $(RECRUITMENT) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.dbscan.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.recruitment.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --classifier decision_tree

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.recruitment.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.dbscan.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
    $(RECRUITMENT) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.dbscan.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.recruitment.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --classifier decision_tree

CATEGORY="binning"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.dbscan.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
    $(BINNING) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.dbscan.tsv --embedded-kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --clustering-method dbscan --domain archaea

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.dbscan.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
   $(BINNING) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.dbscan.tsv --embedded-kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --clustering-method dbscan --domain bacteria

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.hdbscan.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
    $(BINNING) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.binning.hdbscan.tsv --embedded-kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --clustering-method hdbscan --domain archaea

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.hdbscan.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv
   $(BINNING) /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.binning.hdbscan.tsv --embedded-kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv --taxonomy /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv --clustering-method hdbscan --domain bacteria

CATEGORY="blastp"
CORES=20

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.blastp.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa /mnt/autometa_databases/nr.dmnd
    $(BLASTP) blastp --query /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa --out /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.blastp.tsv --db /mnt/autometa_databases/nr.dmnd --evalue 1e-5 --max-target-seqs 200 --outfmt 6 --threads 20

CATEGORY="markers"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa
    $(MARKERS) --orfs /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa --kingdom bacteria --hmmscan /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.hmmscan.tsv --out /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.bacteria.markers.tsv --dbdir /home/evan/Autometa/autometa/databases/markers

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa
    $(MARKERS) --orfs /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa --kingdom archaea --hmmscan /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.hmmscan.tsv --out /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.archaea.markers.tsv --dbdir /home/evan/Autometa/autometa/databases/markers

CATEGORY="kmer-bhsne-embedding"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv --embedded /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.bhsne.tsv --size 5 --norm-method am_clr --do-pca --pca-dimensions 50 --embed-dimensions 2 --embed-method bhsne

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.bhsne.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv --embedded /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.bhsne.tsv --size 5 --norm-method ilr --do-pca --pca-dimensions 50 --embed-dimensions 2 --embed-method bhsne

CATEGORY="kmer-umap-embedding"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.umap.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv --embedded /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.umap.tsv --size 5 --norm-method am_clr --do-pca --pca-dimensions 50 --embed-dimensions 2 --embed-method umap

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.umap.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv --embedded /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.umap.tsv --size 5 --norm-method ilr --do-pca --pca-dimensions 50 --embed-dimensions 2 --embed-method umap

CATEGORY="kmer-normalization"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.ilr.tsv --norm-method ilr --size 5

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --normalized /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.am_clr.tsv --norm-method am_clr --size 5

CATEGORY="kmer-counting"
CORES=10

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna
    $(KMERS) --fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --kmers /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.kmers.tsv --multiprocess --cpus 10

CATEGORY="taxonomy-assignment"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.blastp.tsv
    $(TAXONOMY) --ncbi /mnt/autometa_databases/ --assembly /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --nucl-orfs /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna --prot-orfs /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa --blast /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.blastp.tsv --hits /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.hits.pkl.gz --lca /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.lca.tsv --method majority_vote /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.taxonomy.tsv

CATEGORY="coverage"

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna
    $(COVERAGES) --from-spades --assembly /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --out /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.coverages.tsv

CATEGORY="orf-calling"
# CORES=5

/home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna
    $(ORFS) -i /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna -a /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa -d /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna -p meta

# TODO: Replace with autometa-call-orfs entrypoint
# /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna : /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna
#    $(ORFS) -i /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --prots /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.faa --nucls /home/evan/marine_drugs/marine_drugs/data/interim/binning/FL2015_4.orfs.fna --cpus=5

CATEGORY="length-filter"

/home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna : /home/evan/marine_drugs/marine_drugs/data/raw/assemblies/FL2015_4.fasta
    $(LENGTH_FILTER) /home/evan/marine_drugs/marine_drugs/data/raw/assemblies/FL2015_4.fasta /home/evan/marine_drugs/marine_drugs/data/interim/assemblies/FL2015_4.filtered.fna --cutoff 900
